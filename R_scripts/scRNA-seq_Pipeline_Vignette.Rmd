---
title: "CITE-Seq_Seurat"
output: html_document
date: "2024-10-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# CITE-Seq Pipeline

Based on https://github.com/satijalab/seurat/blob/master/vignettes/seurat5_aml3k_tutorial.Rmd

## Load Libraries

```{r message=FALSE, warning=FALSE}
library(Seurat)
library(scater)
library(ggvenn)
library(ggpubr)
library(dplyr)
library(hdf5r)
```

## Remove Ambient RNA

This is done using Cellbender, but requires the raw `.h5` file to work.

## Read in the Data and Filter Cells and Genes

```{r}
getwd()
data <- Read10X_h5("../Data/SAB005_reseq/raw_feature_bc_matrix.h5")
aml <- CreateSeuratObject(counts = data$`Gene Expression`, min.cells = 3, min.features = 100)
aml[["ADT"]] <- CreateAssayObject(counts = data$`Antibody Capture`[!grepl("Hashtag", rownames(data$`Antibody Capture`)), colnames(aml)])
#aml[["HTO"]] <- CreateAssayObject(counts = data$`Antibody Capture`[grepl("Hashtag", rownames(data$`Antibody Capture`)), colnames(aml)])
#aml <- NormalizeData(aml, assay = 'ADT', normalization.method = 'CLR')
DefaultAssay(aml) <- 'ADT'
aml <- NormalizeData(aml)
DefaultAssay(aml) <- 'RNA'
aml <- NormalizeData(aml)
rm(data)
```


## Calculate Mitochondrial Percentage

```{r}
aml[["percent.mt"]] <- PercentageFeatureSet(aml, pattern = "^MT-")
```

## Visualize QC Metrics

```{r}
# Visualize QC metrics as a violin plot
VlnPlot(aml, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = FALSE, alpha = 0.5)

VlnPlot(aml, features = c("nFeature_ADT", "nCount_ADT","nCount_RNA"), ncol = 3, pt.size = FALSE, alpha = 0.5)

# FeatureScatter is typically used to visualize feature-feature relationships, but can be used for anything calculated by the object, i.e., columns in object metadata, PC scores, etc.
plot1 <- FeatureScatter(aml, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(aml, feature1 = "nCount_RNA", feature2 = "nFeature_RNA") 
plot1 + plot2

aml <- subset(aml, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
```

## Normalize Data

```{r normalize, error=TRUE}
aml <- NormalizeData(aml, normalization.method = "LogNormalize", scale.factor = 1e4)
```

## Identify Variable Features

```{r var_features, fig.height=5, fig.width=11}
DefaultLayer(aml[["RNA"]]) <- "counts"
aml <- FindVariableFeatures(aml, selection.method = 'vst', nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(aml), 50)

# Plot variable features with and without labels
plot1 <- VariableFeaturePlot(aml)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2
# Delete the plots to save on memory
rm(plot1, plot2)
```

## Scale Data and Perform PCA

```{r}
DefaultLayer(aml[["RNA"]]) <- "data"
all.genes <- rownames(aml)
aml <- ScaleData(aml, features = all.genes)

aml <- ScaleData(aml, vars.to.regress = 'percent.mt')
aml <- ScaleData(aml)

aml <- RunPCA(aml, features = VariableFeatures(object = aml))
```

## Visualize PCA Results

```{r}
print(aml[['pca']], dims = 1:5, nfeatures = 5)
VizDimLoadings(aml, dims = 1:2, reduction = 'pca')
DimPlot(aml, reduction = 'pca')
```

```{r}
DimHeatmap(aml, dims = 1:15, cells = 500, balanced = TRUE)
```

## Find Neighbors and Clusters

```{r}
aml <- FindNeighbors(aml, dims = 1:10)
aml <- FindClusters(aml, resolution = 0.5)

# Look at cluster IDs of the first 5 cells
head(Idents(aml), 5)
aml <- RunUMAP(aml, dims = 1:10)
```

## Visualize UMAP and Feature Plot

```{r}
DimPlot(aml, reduction = 'umap', label = TRUE)
```

```{r}
features <- gsub("\\..*", "", rownames(aml[["ADT"]]))
FeaturePlot(aml, features = "CD34", reduction = "umap")
```

```{r}
DimPlot(aml, reduction = 'pca', label = TRUE)
```

```{r}
p1 <- FeaturePlot(aml, "CD19", cols = c("lightgrey", "darkgreen")) + ggtitle("CD19 protein")
DefaultAssay(aml) <- "RNA"
p2 <- FeaturePlot(aml, "CD19") + ggtitle("CD19 RNA")
p1 | p2
```

## Find Marker Genes for both RNA and ADT
```{r}
adt_markers <- FindMarkers(aml, ident.1 = 0, assay = "ADT")
rna_markers <- FindMarkers(aml, ident.1 = 0, assay = "RNA")
head(adt_markers)
# isolate only the markers that have a adjusted p value < 0.05
sum(adt_markers$p_val_adj < 0.05)
sum(rna_markers$p_val_adj < 0.05)
rna_markers[rna_markers$p_val_adj < 0.05, ]
```

```{r}
VlnPlot(aml, "CD19")
RidgePlot(aml, features = c("adt_CD11c", "adt_CD8", "adt_CD16", "CD34"), ncol = 2)
```


## Test for celltype annotation
```{r}
bmmc.ref <- readRDS("../Data/BMMC_ref2.Rds")
```

```{r}
# Use FindTransferAnchors to transfer information from the reference to the query
DefaultAssay(aml) <- "RNA"
DefaultAssay(bmmc.ref) <- "refAssay"
anchors <- FindTransferAnchors(reference = bmmc.ref, query = aml, reference.reduction = "pca", normalization.method = "SCT", dims = 1:10)

```



## Doublet detection and cell type labeling

```{r}

```


# ADT-data preprocessing
```{r}

```


