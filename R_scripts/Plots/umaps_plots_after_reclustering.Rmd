
```{r}
# Load libraries
library(Seurat)
library(dplyr)
library(ggplot2)
```

```{r}
# Load in the object
setwd("C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/AML-CITEseq/Data")
SAB <- readRDS("SAB_slimmed_final_harmony.rds")
```

```{r}
# Make a new meta.data column to assign a predicted celltype to each cluster by majority presence in that cluster
# Set clustering column
cluster_col <- "RNA_snn_res.0.8"  # adjust if your column name is different
celltype_col <- "Triana_celltype"  # adjust to your actual column

# Ensure these are factors
SAB@meta.data[[cluster_col]] <- as.factor(SAB@meta.data[[cluster_col]])
SAB@meta.data[[celltype_col]] <- as.factor(SAB@meta.data[[celltype_col]])

# Majority vote per cluster
library(dplyr)
cluster_majority <- SAB@meta.data %>%
  group_by(cluster = .data[[cluster_col]]) %>%
  count(celltype = .data[[celltype_col]]) %>%
  slice_max(n, n = 1, with_ties = FALSE) %>%
  ungroup()

# Merge with full metadata
lookup <- setNames(cluster_majority$celltype, cluster_majority$cluster)
SAB@meta.data$Triana_cluster_majority_celltype <- lookup[as.character(SAB@meta.data[[cluster_col]])]
```

```{r}
# Make a new meta.data column to assign a predicted celltype to each cluster by majority presence in that cluster
# Set clustering column
cluster_col <- "RNA_snn_res.0.8"  # adjust if your column name is different
celltype_col <- "predicted.celltype.l2"  # adjust to your actual column

# Ensure these are factors
SAB@meta.data[[cluster_col]] <- as.factor(SAB@meta.data[[cluster_col]])
SAB@meta.data[[celltype_col]] <- as.factor(SAB@meta.data[[celltype_col]])

# Majority vote per cluster
library(dplyr)
cluster_majority <- SAB@meta.data %>%
  group_by(cluster = .data[[cluster_col]]) %>%
  count(celltype = .data[[celltype_col]]) %>%
  slice_max(n, n = 1, with_ties = FALSE) %>%
  ungroup()

# Merge with full metadata
lookup <- setNames(cluster_majority$celltype, cluster_majority$cluster)
SAB@meta.data$Azimuth_cluster_majority_celltype <- lookup[as.character(SAB@meta.data[[cluster_col]])]
```

```{r}
setwd("C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/AML-CITEseq/Data")
saveRDS(SAB, "SAB_slimmed_final_harmony.rds")
```


# Layer 1 Azimuth
```{r}
DimPlot(
  object = SAB,
  reduction = "umap",
  group.by = "predicted.celltype.l1",
  label = TRUE,
  raster = FALSE
) +
  ggtitle("predicted.celltype.l1 merged SAB") +
  #NoLegend() +
  theme(plot.title = element_text(hjust = 0.5))

output_dir <- "C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/Graphs/Merge_plots/full_merged_UMAPS"

ggsave(
    filename = file.path(output_dir, paste0("Azimuth_layer1_full_merged_UMAP.jpg")),
    width = 8,
    height = 6,
    dpi = 300
  )
```

# Generate UMAPS
```{r}
# Interesting info on UMAPs
to_make <- c("predicted.celltype.l2", "exp", "Patient", "Genetics", "survival_info", "Triana_cluster_majority_celltype", "day",  "Relapse", "Azimuth_cluster_majority_celltype", "ELN", "Triana_celltype", "RNA_snn_res.0.8")
to_make <- c("RNA_snn_res.0.8")

# Directory to save plots (change if necessary)
output_dir <- "C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/Graphs/Merge_plots/CD34_UMAPS"
#dir.create(output_dir, showWarnings = FALSE)

# Loop through each group.by value and save the plot
for (group in to_make) {
  plot <- DimPlot(
    object = SAB,
    reduction = "harmony_umap",
    group.by = group,
    label = TRUE,
    raster = FALSE
  ) +
    NoLegend() +
    ggtitle(paste(group, "CD34 Sorting")) +
    theme(plot.title = element_text(hjust = 0.5))

  # Save in high resolution (e.g., 300 dpi)
  ggsave(
    filename = file.path(output_dir, paste0(group,".jpg")),
    plot = plot,
    width = 8,
    height = 6,
    dpi = 300
  )
}
```


```{r}
# Save plot
ggsave(
  filename = file.path(output_dir, "Clusters_stacked_by_patient_full_SAB.jpg"),
  plot = plot,
  width = 12,
  height = 8,
  dpi = 300
)
```

## Sequencing Depth correlation
```{r}
library(Signac)
DepthCor(SAB, reduction= "pca")
```

# Patients apart and ggarrange
```{r}
# Unique patients
unique_patients <- unique(SAB@meta.data$Patient)

# Loop through patients to generate and save UMAP plots
for (patient in unique_patients) {
  message(paste("Generating UMAP for patient:", patient))
  
  # Identify cells for current patient
  patient_cells <- rownames(SAB@meta.data[SAB@meta.data$Patient == patient, ])
  
  # Generate plot
  p_patient_umap <- DimPlot(SAB, reduction = "umap",
                            cells.highlight = patient_cells,
                            cols.highlight = "orange",
                            cols = "lightgray",
                            raster = FALSE) +
    ggtitle(paste("UMAP LD - Patient", patient)) +
    NoLegend()
  
  # Save the plot
  filename <- paste0(output_dir, "/UMAP_LD_Patient_", gsub(" ", "_", patient), ".jpeg")
  ggsave(filename, plot = p_patient_umap, width = 8, height = 6, dpi = 300, units = "in")
}


```

# ggarrange for patients
```{r}
library(ggpubr)
library(ggplot2)
library(Seurat)

# Get and sort patients: HC patients first, then rest alphabetically
all_patients <- unique(SAB@meta.data$Patient)
hc_patients <- sort(all_patients[grepl("^HC", all_patients)])           # e.g., HC1, HC2
aml_patients <- sort(all_patients[!grepl("^HC", all_patients)])         # non-HC patients
sorted_patients <- c(hc_patients, aml_patients)

# Create and store plots in a list
patient_umap_list <- list()

for (patient in sorted_patients) {
  message(paste("Creating UMAP for patient:", patient))
  
  patient_cells <- rownames(SAB@meta.data[SAB@meta.data$Patient == patient, ])
  
  p <- DimPlot(SAB, reduction = "Harmony_UMAP",
               cells.highlight = patient_cells,
               cols.highlight = "orange",
               cols = "lightgray",
               raster = FALSE) +
    ggtitle(paste("Patient:", patient)) +
    NoLegend()
  
  patient_umap_list[[patient]] <- p
}

# Arrange plots using ggarrange
combined_plot <- ggarrange(plotlist = patient_umap_list,
                           ncol = 3,
                           nrow = ceiling(length(patient_umap_list) / 3))
```

```{r}
# Save as high-resolution JPEG  
ggsave("All_Patients_UMAP_sorted.jpeg", plot = combined_plot, width = 10, height = 18, dpi = 300, units = "in")

```


# ggarrange for celltypes Azimuth
```{r}
library(Seurat)
library(ggplot2)

# Ensure UMAP was computed under RNA assay
DefaultAssay(SAB) <- "RNA"

# Get all unique cell types (assuming Seurat object has a cell type annotation column)
all_celltypes <- sort(unique(na.omit(SAB@meta.data$predicted.celltype.l2)))

# Initialize list
celltype_umap_list <- list()

# Generate a UMAP for each cell type
for (celltype in all_celltypes) {
  message("Creating UMAP for cell type: ", celltype)

  cells <- rownames(SAB@meta.data)[SAB@meta.data$predicted.celltype.l2 == celltype]

  p <- DimPlot(
    SAB,
    reduction = "Harmony_UMAP",
    cells.highlight = list(cells),
    cols.highlight = "purple",
    cols = "lightgray",
    raster = FALSE
  ) +
    ggtitle(paste("Cell type:", celltype)) +
    theme(plot.title = element_text(size = 10)) +
    NoLegend()

  # Store with safe name
  safe_name <- gsub("[^A-Za-z0-9_]", "_", celltype)
  celltype_umap_list[[safe_name]] <- p
}

library(Seurat)
library(ggplot2)
library(ggpubr)

plots_per_page <- 15
plots_per_row <- 3
plots_per_col <- 5
total_pages <- ceiling(length(celltype_umap_list) / plots_per_page)

for (i in seq_len(total_pages)) {
  start_idx <- (i - 1) * plots_per_page + 1
  end_idx <- min(i * plots_per_page, length(celltype_umap_list))
  plot_subset_names <- names(celltype_umap_list)[start_idx:end_idx]
  
  plot_subset <- lapply(plot_subset_names, function(name) {
    celltype_umap_list[[name]] +
      theme(plot.title = element_text(size = 10)) +
      NoLegend()
  })
  
  # Pad with empty plots if needed
  num_missing <- plots_per_page - length(plot_subset)
  if (num_missing > 0) {
    empty_plot <- ggplot() + theme_void()
    plot_subset <- c(plot_subset, rep(list(empty_plot), num_missing))
  }

  combined_plot <- ggarrange(plotlist = plot_subset,
                             ncol = plots_per_row,
                             nrow = plots_per_col,
                             align = "none")

  # Save to A4 size (portrait): 8.27 x 11.69 inches
  filename <- paste0("UMAP_Celltypes_Page_", i, "_Azimuth_Harmony.jpeg")
  ggsave(filename,
         plot = combined_plot,
         width = 8.27,
         height = 11.69,
         dpi = 300,
         units = "in")
}
```

# Triana celltype ggarrange
```{r}
library(Seurat)
library(ggplot2)

# Ensure UMAP was computed under RNA assay
DefaultAssay(SAB) <- "RNA"

# Get all unique cell types (assuming Seurat object has a cell type annotation column)
all_celltypes <- sort(unique(na.omit(SAB@meta.data$Triana_celltype)))

# Initialize list
celltype_umap_list <- list()

# Generate a UMAP for each cell type
for (celltype in all_celltypes) {
  message("Creating UMAP for cell type: ", celltype)

  cells <- rownames(SAB@meta.data)[SAB@meta.data$Triana_celltype == celltype]

  p <- DimPlot(
    SAB,
    reduction = "Harmony_UMAP",
    cells.highlight = list(cells),
    cols.highlight = "purple",
    cols = "lightgray",
    raster = FALSE
  ) +
    ggtitle(paste(celltype)) +
    theme(plot.title = element_text(size = 10)) +
    NoLegend()

  # Store with safe name
  safe_name <- gsub("[^A-Za-z0-9_]", "_", celltype)
  celltype_umap_list[[safe_name]] <- p
}

library(Seurat)
library(ggplot2)
library(ggpubr)

plots_per_page <- 15
plots_per_row <- 3
plots_per_col <- 5
total_pages <- ceiling(length(celltype_umap_list) / plots_per_page)

for (i in seq_len(total_pages)) {
  start_idx <- (i - 1) * plots_per_page + 1
  end_idx <- min(i * plots_per_page, length(celltype_umap_list))
  plot_subset_names <- names(celltype_umap_list)[start_idx:end_idx]
  
  plot_subset <- lapply(plot_subset_names, function(name) {
    celltype_umap_list[[name]] +
      theme(plot.title = element_text(size = 10)) +
      NoLegend()
  })
  
  # Pad with empty plots if needed
  num_missing <- plots_per_page - length(plot_subset)
  if (num_missing > 0) {
    empty_plot <- ggplot() + theme_void()
    plot_subset <- c(plot_subset, rep(list(empty_plot), num_missing))
  }

  combined_plot <- ggarrange(plotlist = plot_subset,
                             ncol = plots_per_row,
                             nrow = plots_per_col,
                             align = "none")

  # Save to A4 size (portrait): 8.27 x 11.69 inches
  filename <- paste0("UMAP_Celltypes_Page_", i, "_Triana_Harmony.jpeg")
  ggsave(filename,
         plot = combined_plot,
         width = 8.27,
         height = 11.69,
         dpi = 300,
         units = "in")
}
```

# ggarrange for genetics
```{r}
library(Seurat)
library(ggplot2)
library(ggpubr)

# Make sure UMAP is accessible
DefaultAssay(SAB) <- "RNA"

# Get list of genotypes (excluding NA)
genotypes <- sort(unique(na.omit(SAB@meta.data$Genetics)))

# Prepare list of UMAP plots
genetics_umap_list <- list()

# Create one DimPlot per genotype
for (genotype in genotypes) {
  message("Plotting UMAP for genotype: ", genotype)

  cells <- rownames(SAB@meta.data)[SAB@meta.data$Genetics == genotype]
  cells <- unique(na.omit(cells))

  p <- DimPlot(
    SAB,
    reduction = "Harmony_UMAP",
    cells.highlight = list(cells),
    cols.highlight = "firebrick",
    cols = "lightgray",
    raster = FALSE
  ) +
    ggtitle(paste(genotype)) +
    theme(plot.title = element_text(size = 10)) +
    NoLegend()

  safe_name <- gsub("[^A-Za-z0-9_]", "_", genotype)
  genetics_umap_list[[safe_name]] <- p
}

# Arrange in A4 layout: 3 per row, 15 per page
plots_per_row <- 3
plots_per_page <- 15
total_pages <- ceiling(length(genetics_umap_list) / plots_per_page)

# Save pages as JPEGs
for (i in seq_len(total_pages)) {
  start_idx <- (i - 1) * plots_per_page + 1
  end_idx <- min(i * plots_per_page, length(genetics_umap_list))
  subset_plots <- genetics_umap_list[start_idx:end_idx]

  if (length(subset_plots) < plots_per_page) {
    empty_plot <- ggplot() + theme_void()
    subset_plots <- c(subset_plots, rep(list(empty_plot), plots_per_page - length(subset_plots)))
  }

  combined_plot <- ggarrange(
    plotlist = subset_plots,
    ncol = plots_per_row,
    nrow = ceiling(plots_per_page / plots_per_row),
    align = "none"
  )

  ggsave(
    filename = paste0("Genotype_UMAPs_Page_", i, "_Harmony.jpeg"),
    plot = combined_plot,
    width = 8.27,
    height = 11.69,
    units = "in",
    dpi = 300
  )
}

```

# GGarragne of ADT feature plots
```{r}
library(Seurat)
library(ggplot2)
library(ggpubr)

# Make sure RNA assay is default for UMAP
DefaultAssay(SAB) <- "RNA"

# Define all markers of interest
adt_markers <- list(
  "CD13" = "CD13",
  "HLA-DR" = "HLA-DR",
  "CD7.1" = "CD7.1",
  "CD19.1" = "CD19.1",
  "CD56" = "CD56",
  "CD20" = "CD20",
  "CD22.1" = "CD22.1",
  "CD33.1" = "CD33.1"
)

# Initialize empty plot list
plot_list <- list()

# Loop and generate FeaturePlots from ADT data
for (label in names(adt_markers)) {
  marker <- adt_markers[[label]]
  
  if (!(marker %in% rownames(SAB[["ADT"]]@data))) {
    warning(paste("Marker", marker, "not found in ADT assay. Skipping."))
    next
  }
  
  # Temporarily switch to ADT assay
  DefaultAssay(SAB) <- "ADT"
  
  p <- FeaturePlot(
    SAB,
    features = marker,
    reduction = "Harmony_UMAP",
    slot = "data",
    min.cutoff = "q05",
    max.cutoff = "q95",
    pt.size = 0.1,
    raster = FALSE
  ) +
    ggtitle(label) +
    theme(legend.position = "none")
  
  plot_list[[label]] <- p
}

# Restore RNA assay
DefaultAssay(SAB) <- "RNA"

# Arrange plots with ggarrange
final_plot <- ggarrange(
  plotlist = plot_list,
  ncol = 2,
  nrow = ceiling(length(plot_list) / 2)
)

# Show the final arranged plot
ggsave("ADT_FeaturePlots_Harmony.jpeg", plot = final_plot, width = 8.27, height = 11.69, units = "in", dpi = 300)
```

# Specifically have a UMAP with the Patients "HC3" "AML0028" and "AML1941"
```{r}
library(ggpubr)
library(ggplot2)
library(Seurat)

# Specify only the desired patients
selected_patients <- c("HC3", "AML0028", "AML1941")

# Create and store plots in a list
selected_umap_list <- list()

for (patient in selected_patients) {
  message(paste("Creating UMAP for patient:", patient))
  
  patient_cells <- rownames(SAB@meta.data[SAB@meta.data$Patient == patient, ])
  
  p <- DimPlot(SAB, reduction = "umap",
               cells.highlight = patient_cells,
               cols.highlight = "orange",
               cols = "lightgray",
               raster = FALSE) +
    ggtitle(paste("Patient:", patient)) +
    NoLegend()
  
  selected_umap_list[[patient]] <- p
}

# Arrange the selected plots in a single row
combined_selected_plot <- ggarrange(plotlist = selected_umap_list,
                                    ncol = 3,
                                    nrow = 1)

ggsave("selected_patient_umaps.png", combined_selected_plot, width = 12, height = 4)
```

















