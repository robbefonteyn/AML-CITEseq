
```{r}
# Load libraries
library(Seurat)
library(ggplot2)
```

```{r}
# Load in the object
setwd("C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/AML-CITEseq/Data")
#SAB <- readRDS("SAB_slimmed_final.rds")
```

```{r}
# show predicted.celltype.l2 on UMAP and the seurat clusters
DimPlot(SAB, reduction = "tsne", group.by = "predicted.celltype.l2", label = TRUE, raster = FALSE) +
  ggtitle("Predicted Cell Type L2") + NoLegend() +
  theme(plot.title = element_text(hjust = 0.5))

DimPlot(SAB, reduction = "tsne", group.by = "RNA_snn_res.0.8", label = TRUE, raster = FALSE) +
  ggtitle("Predicted Cell Type L2") + NoLegend() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
# Make a new meta.data column to assign a predicted celltype to each cluster by majority presence in that cluster
# Set clustering column
cluster_col <- "RNA_snn_res.0.8"  # adjust if your column name is different
celltype_col <- "Triana_celltype"  # adjust to your actual column

# Ensure these are factors
SAB@meta.data[[cluster_col]] <- as.factor(SAB@meta.data[[cluster_col]])
SAB@meta.data[[celltype_col]] <- as.factor(SAB@meta.data[[celltype_col]])

# Majority vote per cluster
library(dplyr)
cluster_majority <- SAB@meta.data %>%
  group_by(cluster = .data[[cluster_col]]) %>%
  count(celltype = .data[[celltype_col]]) %>%
  slice_max(n, n = 1, with_ties = FALSE) %>%
  ungroup()

# Merge with full metadata
lookup <- setNames(cluster_majority$celltype, cluster_majority$cluster)
SAB@meta.data$Triana_cluster_majority_celltype <- lookup[as.character(SAB@meta.data[[cluster_col]])]
```

```{r}
# Make a new meta.data column to assign a predicted celltype to each cluster by majority presence in that cluster
# Set clustering column
cluster_col <- "RNA_snn_res.0.8"  # adjust if your column name is different
celltype_col <- "predicted.celltype.l2"  # adjust to your actual column

# Ensure these are factors
SAB@meta.data[[cluster_col]] <- as.factor(SAB@meta.data[[cluster_col]])
SAB@meta.data[[celltype_col]] <- as.factor(SAB@meta.data[[celltype_col]])

# Majority vote per cluster
library(dplyr)
cluster_majority <- SAB@meta.data %>%
  group_by(cluster = .data[[cluster_col]]) %>%
  count(celltype = .data[[celltype_col]]) %>%
  slice_max(n, n = 1, with_ties = FALSE) %>%
  ungroup()

# Merge with full metadata
lookup <- setNames(cluster_majority$celltype, cluster_majority$cluster)
SAB@meta.data$Azimuthcluster_majority_celltype <- lookup[as.character(SAB@meta.data[[cluster_col]])]
```


```{r}
DimPlot(
  object = SAB,
  reduction = "umap",
  group.by = "seurat_clusters",
  label = TRUE,
  raster = FALSE
) +
  ggtitle("Seurat clusters merged SAB") +
  NoLegend() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
# Subset the object into LD and CD34+ sorting
#SAB_CD34 <- subset(SAB, subset = Sorting == "L/D")
SAB_CD34 <- subset(SAB, subset = Sorting == "CD34+")
```


```{r}
DimPlot(SAB_CD34, reduction = "umap", group.by = "RNA_snn_res.0.8", label = TRUE, raster = FALSE) +
  ggtitle("Clusters") + NoLegend() +
  theme(plot.title = element_text(hjust = 0.5))

DimPlot(SAB_CD34, reduction = "umap", group.by = "RNA_snn_res.0.8", label = TRUE, raster = FALSE) +
  ggtitle("Clusters") + NoLegend() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
rm(SAB)
SAB_CD34 <- NormalizeData(SAB_CD34)
SAB_CD34 <- FindVariableFeatures(SAB_CD34)
SAB_CD34 <- ScaleData(SAB_CD34)
SAB_CD34 <- RunPCA(SAB_CD34)
SAB_CD34 <- RunUMAP(SAB_CD34, dims = 1:30)
SAB_CD34 <- FindNeighbors(SAB_CD34, dims = 1:30)
SAB_CD34 <- FindClusters(SAB_CD34)
```

```{r}
SAB_CD34 <- readRDS("SAB_CD34.rds")
```

```{r}
# Make a new meta.data column to assign a predicted celltype to each cluster by majority presence in that cluster
# Set clustering column
cluster_col <- "RNA_snn_res.0.8"  # adjust if your column name is different
celltype_col <- "Triana_celltype"  # adjust to your actual column

# Ensure these are factors
SAB_LD@meta.data[[cluster_col]] <- as.factor(SAB_LD@meta.data[[cluster_col]])
SAB_LD@meta.data[[celltype_col]] <- as.factor(SAB_LD@meta.data[[celltype_col]])

# Majority vote per cluster
library(dplyr)
cluster_majority <- SAB_LD@meta.data %>%
  group_by(cluster = .data[[cluster_col]]) %>%
  count(celltype = .data[[celltype_col]]) %>%
  slice_max(n, n = 1, with_ties = FALSE) %>%
  ungroup()

# Merge with full metadata
lookup <- setNames(cluster_majority$celltype, cluster_majority$cluster)
SAB_LD@meta.data$Triana_cluster_majority_celltype <- lookup[as.character(SAB_LD@meta.data[[cluster_col]])]
```

```{r}
DimPlot(
  object = SAB_CD34,
  reduction = "umap",
  group.by = "RNA_snn_res.0.8",
  label = TRUE,
  raster = FALSE
) +
  ggtitle("RNA_snn_res.0.8 CD34 sorting") +
  NoLegend() +
  theme(plot.title = element_text(hjust = 0.5))

DimPlot(
  object = SAB_CD34,
  reduction = "umap",
  group.by = "Azimuth_cluster_majority_celltype",
  label = TRUE,
  raster = FALSE
) +
  ggtitle("Azimuth annotation CD34 sorting") +
  #NoLegend() +
  theme(plot.title = element_text(hjust = 0.5))
```


```{r}
setwd("C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/AML-CITEseq/Data")
#saveRDS(SAB_CD34, file = "SAB_CD34.rds")
```

```{r}
colnames(SAB@meta.data)
```

```{r}
SAB_LD <- readRDS("SAB_LD.rds")
```


```{r}
# Interesting info on UMAPs
to_make <- c("predicted.celltype.l2", "exp", "Patient", "Genetics", "survival_info", "Triana_cluster_majority_celltype", "day",  "Relapse", "Azimuthcluster_majority_celltype", "ELN", "Triana_celltype", "RNA_snn_res.0.8")
#to_make <- c("RNA_snn_res.0.8")

# Directory to save plots (change if necessary)
output_dir <- "C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/Graphs/Merge_plots/full_merged_UMAPS"
#dir.create(output_dir, showWarnings = FALSE)

# Loop through each group.by value and save the plot
for (group in to_make) {
  plot <- DimPlot(
    object = SAB,
    reduction = "umap",
    group.by = group,
    label = TRUE,
    raster = FALSE
  ) +
    NoLegend() +
    ggtitle(paste(group, "full merged")) +
    theme(plot.title = element_text(hjust = 0.5))

  # Save in high resolution (e.g., 300 dpi)
  ggsave(
    filename = file.path(output_dir, paste0(group,"_full_SAB.jpg")),
    plot = plot,
    width = 8,
    height = 6,
    dpi = 300
  )
}
```

```{r}
saveRDS(SAB_CD, "SAB_LD.rds")
```

```{r}
setwd("C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/AML-CITEseq/Data")
SAB <- readRDS("SAB_CD34.rds")
output_dir <- "C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/Graphs/Merge_plots/CD34_UMAPS"
```


```{r}
library(Seurat)
library(dplyr)
library(ggplot2)

# Extract metadata
metadata <- SAB@meta.data

# Summarize counts of patients within each cluster
cluster_patient_counts <- metadata %>%
  group_by(Triana_cluster_majority_celltype, Patient) %>%
  summarise(CellCount = n(), .groups = "drop")

# Create stacked bar plot
plot <- ggplot(cluster_patient_counts, aes(x = Triana_cluster_majority_celltype, y = CellCount, fill = Patient)) +
  geom_bar(stat = "identity") +
  labs(x = "Cluster (Triana)", y = "Number of Cells", fill = "Patient") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave(
    filename = file.path(output_dir, paste0("Patients_per_Triana_celltype_cluster_CD34_SAB.jpg")),
    plot = plot,
    width = 8,
    height = 6,
    dpi = 300
  )

```

```{r}
library(dplyr)
library(ggplot2)

# Extract metadata
metadata <- SAB@meta.data

# Count how many cells of each celltype are present in each Seurat cluster
cluster_celltype_counts <- metadata %>%
  group_by(RNA_snn_res.0.8, Triana_celltype) %>%
  summarise(CellCount = n(), .groups = "drop")

# Convert cluster to factor
cluster_celltype_counts$RNA_snn_res.0.8 <- factor(cluster_celltype_counts$RNA_snn_res.0.8)

# Create plot with black outlines around stacked bar segments
plot <- ggplot(cluster_celltype_counts, aes(x = RNA_snn_res.0.8, y = CellCount, fill = Triana_celltype)) +
  geom_bar(stat = "identity", color = "black", size = 0.1) +  # <-- outlines added here
  labs(x = "Seurat Clusters (Triana)", y = "Number of Cells", fill = "Cell Type") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "right",
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7),
    legend.key.size = unit(0.3, "cm")
  ) +
  guides(fill = guide_legend(ncol = 1))

# Save the plot
ggsave(
  filename = file.path(output_dir, "Triana_celltypes_per_cluster_CD34_SAB.jpg"),
  plot = plot,
  width = 10,
  height = 8,
  dpi = 300
)

```


```{r}
library(dplyr)
library(ggplot2)

# Extract metadata
metadata <- SAB@meta.data

# Count how many cells of each Seurat cluster are present in each cell type
celltype_cluster_counts <- metadata %>%
  group_by(predicted.celltype.l2, RNA_snn_res.0.8) %>%
  summarise(CellCount = n(), .groups = "drop")

# Convert to factors
celltype_cluster_counts$RNA_snn_res.0.8 <- factor(celltype_cluster_counts$RNA_snn_res.0.8)
celltype_cluster_counts$predicted.celltype.l2 <- factor(celltype_cluster_counts$predicted.celltype.l2)

# Create plot
plot <- ggplot(celltype_cluster_counts, aes(x = predicted.celltype.l2, y = CellCount, fill = RNA_snn_res.0.8)) +
  geom_bar(stat = "identity", color = "black", size = 0.1) +
  labs(x = "Cell Type (Azimuth)", y = "Number of Cells", fill = "Seurat Cluster") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "right",
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7),
    legend.key.size = unit(0.3, "cm")
  ) +
  guides(fill = guide_legend(ncol = 1))

# Save plot
ggsave(
  filename = file.path(output_dir, "Azimuth_celltypes_stacked_by_cluster_CD34_SAB.jpg"),
  plot = plot,
  width = 12,
  height = 8,
  dpi = 300
)

```

```{r}
SAB <- readRDS("SAB_slimmed_final.rds")
output_dir <- "C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/Graphs/Merge_plots/full_merged_UMAPS"
```

```{r}
#!!!!!!!!!!!!!!!!!!! Nothing needs to be edited except the filename !!!!!!!!!!!!!!!!!!!!!
library(dplyr)
library(ggplot2)

# Extract metadata
metadata <- SAB@meta.data

# Count how many cells are in each cluster-patient combination
cluster_patient_counts <- metadata %>%
  group_by(RNA_snn_res.0.8, Patient) %>%
  summarise(CellCount = n(), .groups = "drop")

# Convert to factors for controlled plotting
cluster_patient_counts$RNA_snn_res.0.8 <- factor(cluster_patient_counts$RNA_snn_res.0.8)
cluster_patient_counts$Patient <- factor(cluster_patient_counts$Patient)

# Plot: clusters on X, patients stacked in bars
plot <- ggplot(cluster_patient_counts, aes(x = RNA_snn_res.0.8, y = CellCount, fill = Patient)) +
  geom_bar(stat = "identity", color = "black", size = 0.1) +
  labs(x = "Seurat Cluster", y = "Number of Cells", fill = "Patient") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "right",
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7),
    legend.key.size = unit(0.3, "cm")
  ) +
  guides(fill = guide_legend(ncol = 1))
plot
```

```{r}
# Save plot
ggsave(
  filename = file.path(output_dir, "Clusters_stacked_by_patient_full_SAB.jpg"),
  plot = plot,
  width = 12,
  height = 8,
  dpi = 300
)
```






