
```{r}
# Load libraries
library(ggplot2)
library(ggalluvial)
library(Seurat)
library(dplyr)
library(forcats)
```

```{r}
# Load in the object
setwd("C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/AML-CITEseq/Data")
SAB <- readRDS("SAB_slimmed_final.rds")
```

# Sankey plot annotation complete
```{r}
# Column names in metadata
col1 <- "predicted.celltype.l2"
col2 <- "Triana_celltype"

# Create contingency table
sankey_data <- as.data.frame(table(
  Annotation1 = SAB@meta.data[[col1]],
  Annotation2 = SAB@meta.data[[col2]]
)) %>%
  filter(Freq > 0)

# Define how many top levels to keep
top_annotation1 <- sankey_data %>%
  group_by(Annotation1) %>%
  summarise(total = sum(Freq), .groups = "drop") %>%
  slice_max(total, n = 22) %>%
  pull(Annotation1) %>%
  as.character()

top_annotation2 <- sankey_data %>%
  group_by(Annotation2) %>%
  summarise(total = sum(Freq), .groups = "drop") %>%
  slice_max(total, n = 16) %>%
  pull(Annotation2) %>%
  as.character()

# Collapse low-frequency labels into "Other celltypes"
sankey_data <- sankey_data %>%
  mutate(
    Annotation1 = fct_other(as.character(Annotation1), keep = top_annotation1, other_level = "Other celltypes"),
    Annotation2 = fct_other(as.character(Annotation2), keep = top_annotation2, other_level = "Other celltypes")
  )

# Reorder with "Other celltypes" at the top
annotation1_order <- sankey_data %>%
  group_by(Annotation1) %>%
  summarise(total = sum(Freq), .groups = "drop") %>%
  mutate(Annotation1 = as.character(Annotation1)) %>%
  arrange(desc(Annotation1 == "Other celltypes"), total) %>%
  pull(Annotation1)

annotation2_order <- sankey_data %>%
  group_by(Annotation2) %>%
  summarise(total = sum(Freq), .groups = "drop") %>%
  mutate(Annotation2 = as.character(Annotation2)) %>%
  arrange(desc(Annotation2 == "Other celltypes"), total) %>%
  pull(Annotation2)

# Apply factor levels
sankey_data$Annotation1 <- factor(sankey_data$Annotation1, levels = annotation1_order)
sankey_data$Annotation2 <- factor(sankey_data$Annotation2, levels = annotation2_order)

# Plot the Sankey diagram
ggplot(sankey_data,
       aes(axis1 = Annotation1, axis2 = Annotation2, y = Freq)) +
  geom_alluvium(aes(fill = Annotation1), width = 1/12) +
  geom_stratum(width = 1/12, fill = "grey80", color = "black") +
  geom_text(stat = "stratum",
            aes(label = ifelse(after_stat(count) >= 10, as.character(after_stat(stratum)), "")),
            size = 2.5) +
  scale_x_discrete(labels = c("predicted.celltype.l2" = "Azimuth Celltypes",
                              "Triana_celltype" = "Triana Celltypes"),
                   limits = c("predicted.celltype.l2", "Triana_celltype"),
                   expand = c(.05, .05)) +
  labs(title = "Mapping Between Azimuth and Triana Celltypes") +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold")
  ) +
  NoLegend()

```

```{r}
ggsave("Sankeyplot_Azimuth_vs_Triana.jpeg", width = 15, height = 10, units = "in", dpi = 300)
```


# Sankey plot per experiment
```{r}
# Column names
col1 <- "predicted.celltype.l2"
col2 <- "Triana_celltype"

# Loop through each unique 'exp' value
for (exp_value in unique(SAB@meta.data$exp)) {
  
  # Subset metadata for the current exp group
  meta_subset <- SAB@meta.data[SAB@meta.data$exp == exp_value, ]
  
  # Create contingency table
  sankey_data <- as.data.frame(table(
    Annotation1 = meta_subset[[col1]],
    Annotation2 = meta_subset[[col2]]
  )) %>%
    filter(Freq > 0)
  
  # Skip if no data
  if (nrow(sankey_data) == 0) next
  
  # Define top N cell types to keep
  top_annotation1 <- sankey_data %>%
    group_by(Annotation1) %>%
    summarise(total = sum(Freq), .groups = "drop") %>%
    slice_max(total, n = 22) %>%
    pull(Annotation1) %>%
    as.character()
  
  top_annotation2 <- sankey_data %>%
    group_by(Annotation2) %>%
    summarise(total = sum(Freq), .groups = "drop") %>%
    slice_max(total, n = 16) %>%
    pull(Annotation2) %>%
    as.character()
  
  # Collapse low-frequency labels
  sankey_data <- sankey_data %>%
    mutate(
      Annotation1 = fct_other(as.character(Annotation1), keep = top_annotation1, other_level = "Other celltypes"),
      Annotation2 = fct_other(as.character(Annotation2), keep = top_annotation2, other_level = "Other celltypes")
    )
  
  # Reorder with "Other celltypes" at the top
  annotation1_order <- sankey_data %>%
    group_by(Annotation1) %>%
    summarise(total = sum(Freq), .groups = "drop") %>%
    mutate(Annotation1 = as.character(Annotation1)) %>%
    arrange(desc(Annotation1 == "Other celltypes"), total) %>%
    pull(Annotation1)
  
  annotation2_order <- sankey_data %>%
    group_by(Annotation2) %>%
    summarise(total = sum(Freq), .groups = "drop") %>%
    mutate(Annotation2 = as.character(Annotation2)) %>%
    arrange(desc(Annotation2 == "Other celltypes"), total) %>%
    pull(Annotation2)
  
  sankey_data$Annotation1 <- factor(sankey_data$Annotation1, levels = annotation1_order)
  sankey_data$Annotation2 <- factor(sankey_data$Annotation2, levels = annotation2_order)
  
  # Plot
  p <- ggplot(sankey_data,
              aes(axis1 = Annotation1, axis2 = Annotation2, y = Freq)) +
    geom_alluvium(aes(fill = Annotation1), width = 1/12) +
    geom_stratum(width = 1/12, fill = "grey80", color = "black") +
    geom_text(stat = "stratum",
              aes(label = ifelse(after_stat(count) >= 10, as.character(after_stat(stratum)), "")),
              size = 2.5) +
    scale_x_discrete(labels = c("predicted.celltype.l2" = "Azimuth Celltypes",
                                "Triana_celltype" = "Triana Celltypes"),
                     limits = c("predicted.celltype.l2", "Triana_celltype"),
                     expand = c(.05, .05)) +
    labs(title = paste("Mapping Between Azimuth and Triana Celltypes:", exp_value)) +
    theme_minimal() +
    theme(
      axis.title.y = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold")
    ) +
    NoLegend()
  
  # Save plot
  ggsave(
    filename = paste0("sankey_", gsub("[^a-zA-Z0-9]", "_", exp_value), ".jpg"),
    plot = p,
    width = 10,
    height = 6,
    dpi = 300
  )
}

```

# Sankey per experiment with no "Other" grouping
```{r}
library(ggplot2)
library(ggalluvial)
library(Seurat)
library(dplyr)
library(forcats)

# Column names
col1 <- "predicted.celltype.l2"
col2 <- "Triana_celltype"

# Loop through each unique 'exp' value
for (exp_value in unique(SAB@meta.data$exp)) {
  
  # Subset metadata for the current exp group
  meta_subset <- SAB@meta.data[SAB@meta.data$exp == exp_value, ]
  
  # Create contingency table
  sankey_data <- as.data.frame(table(
    Annotation1 = meta_subset[[col1]],
    Annotation2 = meta_subset[[col2]]
  )) %>%
    filter(Freq > 0)
  
  # Skip if no data
  if (nrow(sankey_data) == 0) next
  
  # Define top N cell types to keep
  top_annotation1 <- sankey_data %>%
    group_by(Annotation1) %>%
    summarise(total = sum(Freq), .groups = "drop") %>%
    slice_max(total, n = 22) %>%
    pull(Annotation1) %>%
    as.character()
  
  top_annotation2 <- sankey_data %>%
    group_by(Annotation2) %>%
    summarise(total = sum(Freq), .groups = "drop") %>%
    slice_max(total, n = 16) %>%
    pull(Annotation2) %>%
    as.character()
  
  # Collapse low-frequency labels
#  sankey_data <- sankey_data %>%
#    mutate(
#      Annotation1 = fct_other(as.character(Annotation1), keep = top_annotation1, other_level = "Other celltypes"),
#      Annotation2 = fct_other(as.character(Annotation2), keep = top_annotation2, other_level = "Other celltypes")
#    )
  
  # Reorder by frequency (no "Other" grouping)
  annotation1_order <- sankey_data %>%
    group_by(Annotation1) %>%
    summarise(total = sum(Freq), .groups = "drop") %>%
    arrange(total) %>%
    pull(Annotation1)
  
  annotation2_order <- sankey_data %>%
    group_by(Annotation2) %>%
    summarise(total = sum(Freq), .groups = "drop") %>%
    arrange(total) %>%
    pull(Annotation2)

  
  sankey_data$Annotation1 <- factor(sankey_data$Annotation1, levels = annotation1_order)
  sankey_data$Annotation2 <- factor(sankey_data$Annotation2, levels = annotation2_order)
  
  # Plot
  p <- ggplot(sankey_data,
              aes(axis1 = Annotation1, axis2 = Annotation2, y = Freq)) +
    geom_alluvium(aes(fill = Annotation1), width = 1/12) +
    geom_stratum(width = 1/12, fill = "grey80", color = "black") +
    geom_text(stat = "stratum",
              aes(label = ifelse(after_stat(count) >= 10, as.character(after_stat(stratum)), "")),
              size = 1.5) +
    scale_x_discrete(labels = c("predicted.celltype.l2" = "Azimuth Celltypes",
                                "Triana_celltype" = "Triana Celltypes"),
                     limits = c("predicted.celltype.l2", "Triana_celltype"),
                     expand = c(.05, .05)) +
    labs(title = paste("Mapping Between Azimuth and Triana Celltypes:", exp_value)) +
    theme_minimal() +
    theme(
      axis.title.y = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold")
    ) +
    NoLegend()
  
  # Save plot
  ggsave(
    filename = paste0("sankey_Azimuth_vs_Triana_", gsub("[^a-zA-Z0-9]", "_", exp_value), ".jpg"),
    plot = p,
    width = 10,
    height = 6,
    dpi = 300
  )
}
```

# Jaccard Similarity matrix
```{r}
# Load necessary libraries
library(dplyr)
library(Matrix)
library(clue)
library(pheatmap)

# Step 1: Extract metadata
cell_df <- SAB@meta.data %>%
  select(predicted.celltype.l2, Triana_celltype) %>%
  mutate(cell = rownames(SAB@meta.data)) %>%
  filter(!is.na(predicted.celltype.l2), !is.na(Triana_celltype))  # Remove NAs

# Step 2: Get unique labels
azimuth_labels <- unique(cell_df$predicted.celltype.l2)
triana_labels  <- unique(cell_df$Triana_celltype)

# Step 3: Initialize Jaccard matrix
jaccard_matrix <- matrix(0, nrow = length(azimuth_labels), ncol = length(triana_labels),
                         dimnames = list(azimuth_labels, triana_labels))

# Step 4: Compute Jaccard similarity
for (a in azimuth_labels) {
  a_cells <- cell_df$cell[cell_df$predicted.celltype.l2 == a]
  
  for (t in triana_labels) {
    t_cells <- cell_df$cell[cell_df$Triana_celltype == t]
    
    intersection <- length(intersect(a_cells, t_cells))
    union        <- length(union(a_cells, t_cells))
    
    jaccard_matrix[a, t] <- ifelse(union > 0, intersection / union, 0)
  }
}

# Step 5: Sanity check
if (nrow(jaccard_matrix) == 0 || ncol(jaccard_matrix) == 0 || all(jaccard_matrix == 0)) {
  stop("The Jaccard matrix is empty or has no overlap between cell type labels.")
}

# Step 6: Square the matrix for Hungarian algorithm
nr <- nrow(jaccard_matrix)
nc <- ncol(jaccard_matrix)
max_dim <- max(nr, nc)

square_matrix <- matrix(0, nrow = max_dim, ncol = max_dim)
square_matrix[1:nr, 1:nc] <- jaccard_matrix

# Step 7: Solve optimal matching
assignment <- solve_LSAP(square_matrix, maximum = TRUE)

# Step 8: Reorder original (unpadded) matrix
optimal_rows <- rownames(jaccard_matrix)
valid_assignments <- assignment[1:nrow(jaccard_matrix)]

# Only keep those assignments within original column count
valid_assignments <- valid_assignments[valid_assignments <= ncol(jaccard_matrix)]

optimal_cols <- colnames(jaccard_matrix)[valid_assignments]
optimal_rows <- rownames(jaccard_matrix)[seq_along(valid_assignments)]

# Final reordered matrix (safe)
jaccard_ordered <- jaccard_matrix[optimal_rows, optimal_cols]

# Step 9: Final check before plotting
if (all(!is.finite(jaccard_ordered)) || all(jaccard_ordered == 0)) {
  stop("Reordered Jaccard matrix is not suitable for plotting.")
}

# Step 10: Plot
map <- pheatmap(jaccard_ordered,
         main = "Triana and Azimuth Jaccard Similarity",
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         fontsize_row = 8,
         fontsize_col = 8,
         na_col = "grey90")

```

```{r}
ggsave("Jaccard_Similarity_Azimuth_vs_Triana.jpg", plot = map, width = 15, height = 10, units = "in", dpi = 300)
```

# Regular heatmap between annotation
```{r}
library(dplyr)
library(pheatmap)

# Get metadata
celltypes_df <- SAB@meta.data %>%
  filter(!is.na(predicted.celltype.l2), !is.na(Triana_celltype)) %>%
  select(predicted.celltype.l2, Triana_celltype)

# Create a frequency table (confusion matrix)
confusion_matrix <- table(celltypes_df$predicted.celltype.l2,
                          celltypes_df$Triana_celltype)

# Convert to matrix (if not already)
confusion_matrix <- as.matrix(confusion_matrix)

# Plot heatmap
map <- pheatmap(confusion_matrix,
         main = "Heatmap Azimuth vs Triana annotation",
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         fontsize_row = 8,
         fontsize_col = 8)

ggsave("Heatmap_Azimuth_vs_Triana_annotation.jpg", plot = map, width = 15, height = 10, units = "in", dpi = 300)

```

```{r}
library(dplyr)
library(tidyr)
library(pheatmap)
library(tibble)

# Detect RNA SNN clustering column
snn_col <- grep("^RNA_snn_res", colnames(SAB@meta.data), value = TRUE)[1]
if (is.null(snn_col)) stop("No RNA_snn_res.* column found in metadata.")

# Create table of counts
cluster_patient_table <- SAB@meta.data %>%
  filter(!is.na(.data[[snn_col]]), !is.na(Patient)) %>%
  count(Cluster = .data[[snn_col]], Patient) %>%
  pivot_wider(names_from = Patient, values_from = n, values_fill = 0)

# Convert Cluster to numeric, sort, and move to rownames
heatmap_matrix <- cluster_patient_table %>%
  mutate(Cluster = as.numeric(as.character(Cluster))) %>%
  arrange(Cluster) %>%
  column_to_rownames("Cluster") %>%
  as.matrix()

# Optional: convert rownames back to character for display
rownames(heatmap_matrix) <- as.character(rownames(heatmap_matrix))

# Plot heatmap
map <- pheatmap(heatmap_matrix,
                main = paste("Heatmap of Cluster (", snn_col, ") vs Patient"),
                cluster_rows = FALSE,  # disable row clustering to preserve order
                cluster_cols = TRUE,
                fontsize_row = 8,
                fontsize_col = 8)

# Save the heatmap
ggsave("Heatmap_cluster_vs_Patient.jpg", plot = map,
       width = 15, height = 10, units = "in", dpi = 300)

```