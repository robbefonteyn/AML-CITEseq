
```{r}
library(Seurat)
library(ggplot2)
```

```{r}
# Load the dataset
SAB <- readRDS("C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/AML-CITEseq/Data/SAB_slimmed_final.rds")
```

```{r}
SAB <- FindNeighbors(SAB, dims = 1:30)
SAB <- FindClusters(SAB)
```

```{r}
plot <- DimPlot(
  object = SAB,
  reduction = "Harmony_UMAP",
  group.by = "RNA_snn_res.0.8",
  label = TRUE,
  raster = FALSE,         # Ensures high-resolution vector output
  repel = TRUE            # Optional: avoids overlapping labels
) +
  ggtitle("RNA_snn_res.0.8 full merged object Harmony") +
  NoLegend() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16)
  )

# Save the UMAP plot to file
ggsave(
  filename = "RNA_snn_res.0.8_CD34_Sorting.jpeg",
  plot = plot,
  width = 10,            # You can increase to 16 for presentations
  height = 8,
  units = "in",
  dpi = 300              # Publication-quality resolution
)
```


```{r}
# Make a new meta.data column to assign a predicted celltype to each cluster by majority presence in that cluster
# Set clustering column
cluster_col <- "RNA_snn_res.0.8"  # adjust if your column name is different
celltype_col <- "Triana_celltype"  # adjust to your actual column

# Ensure these are factors
SAB@meta.data[[cluster_col]] <- as.factor(SAB@meta.data[[cluster_col]])
SAB@meta.data[[celltype_col]] <- as.factor(SAB@meta.data[[celltype_col]])

# Majority vote per cluster
library(dplyr)
cluster_majority <- SAB@meta.data %>%
  group_by(cluster = .data[[cluster_col]]) %>%
  count(celltype = .data[[celltype_col]]) %>%
  slice_max(n, n = 1, with_ties = FALSE) %>%
  ungroup()

# Merge with full metadata
lookup <- setNames(cluster_majority$celltype, cluster_majority$cluster)
SAB@meta.data$Triana_cluster_majority_celltype <- lookup[as.character(SAB@meta.data[[cluster_col]])]
```

```{r}
# Make a new meta.data column to assign a predicted celltype to each cluster by majority presence in that cluster
# Set clustering column
cluster_col <- "RNA_snn_res.0.8"  # adjust if your column name is different
celltype_col <- "predicted.celltype.l2"  # adjust to your actual column

# Ensure these are factors
SAB@meta.data[[cluster_col]] <- as.factor(SAB@meta.data[[cluster_col]])
SAB@meta.data[[celltype_col]] <- as.factor(SAB@meta.data[[celltype_col]])

# Majority vote per cluster
library(dplyr)
cluster_majority <- SAB@meta.data %>%
  group_by(cluster = .data[[cluster_col]]) %>%
  count(celltype = .data[[celltype_col]]) %>%
  slice_max(n, n = 1, with_ties = FALSE) %>%
  ungroup()

# Merge with full metadata
lookup <- setNames(cluster_majority$celltype, cluster_majority$cluster)
SAB@meta.data$Azimuth_cluster_majority_celltype <- lookup[as.character(SAB@meta.data[[cluster_col]])]
```

```{r}
plot <- DimPlot(
  object = SAB,
  reduction = "Harmony_UMAP",
  group.by = "Azimuth_cluster_majority_celltype",
  label = TRUE,
  raster = FALSE
) +
  ggtitle("Azimuth by majority full merged object Harmony") +
  NoLegend() +
  theme(plot.title = element_text(hjust = 0.5))

ggsave(
  filename = "Azimuth_majority_celltype_Full_SAB_Harmony.jpeg",
  plot = plot,
  width = 10,            # You can increase to 16 for presentations
  height = 8,
  units = "in",
  dpi = 300              # Publication-quality resolution
)
```

```{r}
plot <- DimPlot(
  object = SAB,
  reduction = "Harmony_UMAP",
  group.by = "Triana_cluster_majority_celltype",
  label = TRUE,  # Turn on labels
  label.size = 3,  # Smaller label size
  raster = FALSE
) +
  ggtitle("Triana by majority full merged object Harmony") +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9))  

ggsave(
  filename = "Triana_majority_celltype_Full_SAB_Harmony.jpeg",
  plot = plot,
  width = 10,            # You can increase to 16 for presentations
  height = 8,
  units = "in",
  dpi = 300              # Publication-quality resolution
)

```

```{r}
#saveRDS(SAB, "C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/AML-CITEseq/Data/SAB_slimmed_final.rds")
```

```{r}
# Extract metadata from Seurat object
metadata <- SAB@meta.data

# Select relevant columns
cell_metadata_export <- metadata %>%
  select(RNA_snn_res.0.8, Patient, predicted.celltype.l2, Triana_celltype, 
         Triana_cluster_majority_celltype, Azimuth_cluster_majority_celltype)

# Optional: give more user-friendly column names
colnames(cell_metadata_export) <- c("Cluster", "Patient", "Azimuth_CellType", "Triana_CellType", 
                                    "Triana_Majority_CellType", "Azimuth_Majority_CellType")

# Save to CSV
write.csv(cell_metadata_export,
          file = file.path("C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/Graphs/Merge_plots", 
                          "metadata_for_UMAPs_full_merge.csv"),
          row.names = TRUE)  # Includes cell barcodes

```

