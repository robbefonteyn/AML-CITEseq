---
title: "Code_for_plots.R"
author: "Robbe Fonteyn"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
setwd("C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/AML-CITEseq/Data/Annotation")
meta <- read.csv("Metadata_with_seurat_cellNr.csv", header = TRUE, sep = ",")

library(ggplot2)
library(scales)  # For rescaling function
library(ggpattern)
library(dplyr)
library(tibble)
library(RColorBrewer)
```

```{r}
# Define custom blue scale colors
color_palette <- c("#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", 
                "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf",
                "#a55194", "#393b79", "#8c6d31", "#e7ba52", "#843c39",
                "#d6616b", "#7b4173", "#fdae6b", "#31a354", "#636363")
```

```{r}
# Install if needed
install.packages("ggtext")

library(ggtext)

# Create colored HTML-style x-axis labels
meta$exp_colored <- paste0(
  "<span style='color:", day_colors[as.character(meta$day)], "'>", meta$exp, "</span>"
)

# Keep only one label per sample
axis_labels <- meta[!duplicated(meta$exp), c("exp", "exp_colored")]
label_map <- setNames(axis_labels$exp_colored, axis_labels$exp)

```


```{r}
# Make sure 'day' and 'sample.type' are factors if needed
#meta$day <- as.factor(meta$day)
meta$sample.type <- as.factor(meta$sample.type)
# Create named vector to color x-axis labels by day
#day_colors <- c("1" = "#E41A1C", "2" = "#377EB8", "3" = "#4DAF4A")  # customize as needed
#names(day_colors) <- levels(meta$day)

# Ensure day_colors is properly defined for all unique days
unique_days <- unique(meta$day)
day_colors <- setNames(RColorBrewer::brewer.pal(length(unique_days), "Set1"), unique_days)

# Create named vector of axis label colors based on day
day_by_exp <- meta[!duplicated(meta$exp), c("exp", "day")]
axis_label_colors <- setNames(day_colors[as.character(day_by_exp$day)], day_by_exp$exp)

# Plot
ggplot(meta, aes(x = exp, y = Nr.cells.sorted, fill = Patient, pattern = sample.type)) + 
  geom_bar_pattern(
  position = "fill", stat = "identity", 
  color = "grey",
  pattern_fill = "black",
  pattern_density = 0.01,          # more filled pattern
  pattern_spacing = 0.01,         # smaller/tighter pattern
  pattern_key_scale_factor = 0.5  # smaller legend key pattern
  ) +
  
  # Text labels
  geom_text(aes(label = Nr.cells.sorted, 
                angle = ifelse(Nr.cells.sorted < quantile(Nr.cells.sorted, 0.1), 0, 90)),  
            position = position_fill(vjust = 0.5),
            size = 3, 
            color = "white",
            check_overlap = TRUE) +
  
  facet_wrap(~ Sorting, scales = "free_x") + 
  theme_bw() +
  
  # Color x-axis labels by day
  scale_x_discrete(labels = label_map) +
  
  theme(
  axis.text.x = ggtext::element_markdown(angle = 90, hjust = 1, vjust = 0.5),
  legend.title = element_text(size = 10),
  legend.text = element_text(size = 8),  
  legend.spacing.y = unit(0.2, "cm"),   # reduce vertical spacing between keys
  legend.key.size = unit(0.9, "lines")
  ) +
  
  # Custom fill colors for Patient
  scale_fill_manual(values = color_palette) +
  
  # Custom pattern types for sample.type
  scale_pattern_manual(values = c("BM" = "circle", "PB" = "crosshatch", "AF" = "none"))  # Add more if needed
```

```{r}
getwd()
# Save plot as high-resolution PNG
ggsave("dataset_overview_sorted_cells.png", width = 10, height = 6, dpi = 300)
```
```{r}
# Make sure 'day' and 'sample.type' are factors if needed
#meta$day <- as.factor(meta$day)
meta$sample.type <- as.factor(meta$sample.type)
# Create named vector to color x-axis labels by day
#day_colors <- c("1" = "#E41A1C", "2" = "#377EB8", "3" = "#4DAF4A")  # customize as needed
#names(day_colors) <- levels(meta$day)

# Ensure day_colors is properly defined for all unique days
unique_days <- unique(meta$day)
day_colors <- setNames(RColorBrewer::brewer.pal(length(unique_days), "Set1"), unique_days)

# Create named vector of axis label colors based on day
day_by_exp <- meta[!duplicated(meta$exp), c("exp", "day")]
axis_label_colors <- setNames(day_colors[as.character(day_by_exp$day)], day_by_exp$exp)

# Plot
ggplot(meta, aes(x = exp, y = Seurat_cells, fill = Patient, pattern = sample.type)) + 
  geom_bar_pattern(
  position = "fill", stat = "identity", 
  color = "grey",
  pattern_fill = "black",
  pattern_density = 0.01,          # more filled pattern
  pattern_spacing = 0.01,         # smaller/tighter pattern
  pattern_key_scale_factor = 0.5  # smaller legend key pattern
  ) +
  
  # Text labels
  geom_text(aes(label = Seurat_cells, 
                angle = ifelse(Seurat_cells < quantile(Seurat_cells, 0.1), 0, 90)),  
            position = position_fill(vjust = 0.5),
            size = 3, 
            color = "white",
            check_overlap = TRUE) +
  
  facet_wrap(~ Sorting, scales = "free_x") + 
  theme_bw() +
  
  # Color x-axis labels by day
  scale_x_discrete(labels = label_map) +
  
  theme(
  axis.text.x = ggtext::element_markdown(angle = 90, hjust = 1, vjust = 0.5),
  legend.title = element_text(size = 10),
  legend.text = element_text(size = 8),  
  legend.spacing.y = unit(0.2, "cm"),   # reduce vertical spacing between keys
  legend.key.size = unit(0.9, "lines")
  ) +
  
  # Custom fill colors for Patient
  scale_fill_manual(values = color_palette) +
  
  # Custom pattern types for sample.type
  scale_pattern_manual(values = c("BM" = "circle", "PB" = "crosshatch", "AF" = "none"))  # Add more if needed
```
```{r}
# Save plot as high-resolution PNG
ggsave("dataset_overview_seurat_cells_by_day_and_sampletype.png", width = 10, height = 6, dpi = 300)
```



```{r}
# Create the plot with improved label placement
ggplot(meta, aes(x = exp, y = Seurat_cells, fill = Patient)) + 
  geom_bar(position = "fill", stat = "identity", color = "grey") + 
  
  # Labels: Vertical for most, Horizontal for small bars
  geom_text(aes(label = Seurat_cells, 
                angle = ifelse(Seurat_cells < quantile(Seurat_cells, 0.1), 0, 90)),  
            position = position_fill(vjust = 0.5),  # Keeps text centered within bars
            size = 3, 
            color = "white", 
            check_overlap = TRUE) +  # Prevents excessive overlap
  theme_bw() + 
  facet_wrap(~ Sorting, scales = "free_x")  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_fill_manual(values = color_palette)
# Save plot as high-resolution PNG
ggsave("dataset_overview_seurat_cells.png", width = 10, height = 6, dpi = 300)
```

```{r}
# Create the plot with improved label placement
ggplot(meta, aes(x = exp, y = Nr.cells.sorted, fill = Patient)) + 
  geom_bar(position = "fill", stat = "identity", color = "grey") + 
  
  # Labels: Vertical for most, Horizontal for small bars
  geom_text(aes(label = Nr.cells.sorted, 
                angle = ifelse(Nr.cells.sorted < quantile(Nr.cells.sorted, 0.1), 0, 90)),  
            position = position_fill(vjust = 0.5),  # Keeps text centered within bars
            size = 3, 
            color = "white", 
            check_overlap = TRUE) +  # Prevents excessive overlap
  theme_bw() +
  facet_wrap(~ Sorting, scales = "free_x")  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_fill_manual(values = color_palette)

# Save plot as high-resolution PNG
ggsave("dataset_overview_sorted_cells.png", width = 10, height = 6, dpi = 300)
```


