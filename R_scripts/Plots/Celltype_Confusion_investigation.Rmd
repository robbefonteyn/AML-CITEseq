```{r}
library(Seurat)
library(ggplot2)
library(dplyr)
```

```{r}
# Load the dataset
SAB <- readRDS("C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/AML-CITEseq/Data/SAB_slimmed_final_harmony.rds")
output_dir <- "C:/Users/Robbe Fonteyn/OneDrive - UGent/AJ 2024-2025/Master's_Dissertation/Figures_for_thesis/Confusion_Featureplots"
```

# Confusion of celltype investigation
```{r}
DefaultAssay(SAB) <- "ADT"
adt_features <- rownames(SAB[["ADT"]])
```

```{r}
grep("CD45", adt_features, value = TRUE)     
grep("CD3", adt_features, value = TRUE)   
grep("TCR", adt_features, value = TRUE)
grep("CD4", adt_features, value = TRUE)
grep("CD197", adt_features, value = TRUE)
grep("CD45RA", adt_features, value = TRUE)
grep("CD25", adt_features, value = TRUE)
grep("CD26", adt_features, value = TRUE)
grep("CD28", adt_features, value = TRUE)
#

adt_marker_map <- c(
  "CD3+"   = "CD3-0034",
  "TCRab+"  = "TCR a/b",      
  "CD45RA-" = "CD45RA",
  "CD4+"  = "CD4-0045",
  "CD197-" = "CD197",
  "CD25+" = "CD25",
  "CD26+" = "CD26",
  "CD28+" = "CD28.1"
)
```


Early Promyelocytes is confused a lot with HSPC, GMP, HSC, EMP, LMPP
```{r}
library(Seurat)
library(ggplot2)
library(patchwork)

# Generate a list of FeaturePlots, inverting color scale for "-" markers
feature_plots <- lapply(names(adt_marker_map), function(marker_label) {
  feature <- adt_marker_map[[marker_label]]
  is_negative <- grepl("-$", marker_label)
  clean_label <- gsub("[+-]$", "", marker_label)
  
  p <- FeaturePlot(
    SAB,
    reduction = "RNA_harmony_umap",
    features = feature,
    min.cutoff = "q05",
    max.cutoff = "q95",
    raster = FALSE
  ) + ggtitle(marker_label)
  
  if (is_negative) {
    p <- p + scale_color_viridis_c(direction = -1)
  }
  
  return(p)
})

# Arrange the plots
wrap_plots(feature_plots, ncol = 2)
```
```{r}
ggsave(paste0(output_dir, "/CD4_memory_T_cells_cellmarkers_Triana.jpeg"), height = 20, width = 12)
```

```{r}
# === USER INPUT ===
annotation_col1 <- "Triana_celltype"
annotation_col2 <- "predicted.celltype.l2"
celltype_1 <- "CD4+ memory T cells"
celltype_2_vector <- c("CD4 TCM", "CD4 Naive", "Early Eryth", "Eryth")  # multiple values to test
reduction_used <- "RNA_harmony_umap"

# === Load libraries
library(Seurat)
library(ggplot2)
library(ggpubr)

# === Extract UMAP coordinates and metadata
umap_df <- as.data.frame(Embeddings(SAB, reduction = reduction_used))
colnames(umap_df) <- c("UMAP_1", "UMAP_2")  # rename for consistent plotting
umap_df$cell <- rownames(umap_df)
umap_df$anno1 <- SAB[[annotation_col1]][, 1]
umap_df$anno2 <- SAB[[annotation_col2]][, 1]

# === Generate plots
umap_plots <- lapply(celltype_2_vector, function(ct2) {
  
  umap_df$highlight <- ifelse(
    umap_df$anno1 == celltype_1 & umap_df$anno2 == ct2,
    "Highlight", "Other"
  )
  
  ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2)) +
    geom_point(data = subset(umap_df, highlight == "Other"),
               color = "grey80", size = 0.3) +
    geom_point(data = subset(umap_df, highlight == "Highlight"),
               color = "red", size = 0.5) +
    theme_void() +
    ggtitle(paste(celltype_1, "+", ct2)) +
    coord_equal()
})

# === Arrange into a grid
ggarrange(plotlist = umap_plots, ncol = 2, nrow = ceiling(length(umap_plots) / 2))
```
```{r}
ggsave(paste0(output_dir, "/CD4+_memory_T_cells_confusion.jpeg"), height = 8, width = 15)
```


```{r}

```







